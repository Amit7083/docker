## ClusterControl 1.2.9, Percona Server 5.6, CentOS 6.6 64bit
## The OS distribution running on managed nodes must be the same with controller node
## If your database nodes are running on Ubuntu/Debian, use clustercontrol-debian Dockerfile instead

FROM centos:6
MAINTAINER Ashraf Sharif <ashraf@severalnines.com>

## list of packages to be installed by package manager
ENV PACKAGE curl mailx cronie nc bind-utils clustercontrol clustercontrol-cmonapi clustercontrol-controller Percona-Server-server-56 percona-xtrabackup openssh-clients openssh-server

# install packages
RUN yum -y install wget
RUN rpm --import http://repo.severalnines.com/severalnines-repos.asc
RUN wget www.severalnines.com/downloads/cmon/s9s-repo.repo -P /etc/yum.repos.d/
RUN yum -y install http://www.percona.com/downloads/percona-release/redhat/0.1-3/percona-release-0.1-3.noarch.rpm
RUN yum -y install $PACKAGE

## configure MySQL
ADD my.cnf /etc/my.cnf

## post-installation: setting up Apache
RUN cp -f /var/www/html/cmonapi/ssl/server.crt /etc/pki/tls/certs/s9server.crt
RUN cp -f /var/www/html/cmonapi/ssl/server.key /etc/pki/tls/private/s9server.key
RUN rm -rf /var/www/html/cmonapi/ssl
RUN sed -i 's|AllowOverride None|AllowOverride All|g' /etc/httpd/conf/httpd.conf
RUN sed -i 's|AllowOverride None|AllowOverride All|g' /etc/httpd/conf.d/ssl.conf
RUN sed -i 's|^SSLCertificateFile.*|SSLCertificateFile /etc/pki/tls/certs/s9server.crt|g' /etc/httpd/conf.d/ssl.conf
RUN sed -i 's|^SSLCertificateKeyFile.*|SSLCertificateKeyFile /etc/pki/tls/private/s9server.key|g' /etc/httpd/conf.d/ssl.conf
RUN cp -f /var/www/html/clustercontrol/bootstrap.php.default /var/www/html/clustercontrol/bootstrap.php
RUN cp -f /var/www/html/cmonapi/config/bootstrap.php.default /var/www/html/cmonapi/config/bootstrap.php
RUN cp -f /var/www/html/cmonapi/config/database.php.default /var/www/html/cmonapi/config/database.php
RUN chmod -R 777 /var/www/html/clustercontrol/app/tmp
RUN chmod -R 777 /var/www/html/clustercontrol/app/upload
RUN chown -Rf apache.apache /var/www/html/cmonapi/
RUN chown -Rf apache.apache /var/www/html/clustercontrol/

## ensure required services start on boot
RUN chkconfig mysql on
RUN chkconfig sshd on
RUN chkconfig cmon on

VOLUME ["/var/www/html","/var/lib/mysql","/etc"]

COPY docker-entrypoint.sh /entrypoint.sh
ENTRYPOINT ["/entrypoint.sh"]

## cmon 9500, netcat 9999, haproxy-stats 9600
EXPOSE 22 443 3306 80 9500 9999 9600